\documentclass[useAMS, usenatbib, referee]{biom}
\usepackage{appendix, subfigure}
\usepackage{framed}
%\usepackage{authblk}
\usepackage{bm,amsmath}
\usepackage{amsfonts}
%\usepackage{hyperref}
\usepackage{blkarray}

\usepackage[colorinlistoftodos,linecolor=gray,backgroundcolor=white]{todonotes}

% my command definitions
\input{new_commands}

% RMF: added this new command \dotomega which can be redefined to \dot{\omega} or just \omega if you don't like it:
\newcommand{\dotomega}{\tilde{\omega}}

\setcounter{footnote}{2}





\begin{document}

\title{A latent capture history model for digital aerial surveys}

\author{D. L. Borchers\(^{1, *}\)\email{dlb@st-andrews.ac.uk},
P. Nightingale\(^{2}\),
B. C. Stevenson\(^{3}\), and
R. M. Fewster\(^{3}\) \\
\(^1\)University of St Andrews, Centre for Research into Ecological and Environmental Modelling, \\St Andrews, Fife, UK \\
\(^2\)Department of Computer Science, University of York, Deramore Lane, Heslington, York, UK \\
\(^3\)Department of Statistics, University of Auckland, Private Bag 92019, \\ Auckland, New Zealand
}
%\author[1]{D.L. Borchers\thanks{dlb@st-andrews.ac.uk}}
%\author[2]{P. Nightingale}
%\author[3]{B.C. Stevenson}
%\author[3]{R.M. Fewster}
%\affil[1]{Centre for Research into Ecological and Envoronmental Modelling
%University of St Andrews, The Observatory, Buchanan Gardens, Fife, St Andrews, KY16 9LZ, Scotland}
%\affil[2]{School of Computer Science, Jack Cole Building
%North Haugh, St Andrews, Fife, KY16 9SX, Scotland}
%\affil[3]{Department of Statistics, University of Auckland,
%Private Bag 92019, Auckland, New Zealand}




\date{{\it Received ??} 2019. {\it Revised } 20??}
%{\it Accepted March} 2005.}

\pagerange{\pageref{firstpage}--\pageref{lastpage}} \pubyear{2019}

\volume{00}
\artmonth{??}
\doi{10.1111/j.1541-0420.2005.00454.x}

%  This label and the label ``lastpage'' are used by the \pagerange
%  command above to give the page range for the article

\label{firstpage}

%  pub the summary here



\begin{abstract}
  We anticipate that unmanned aerial vehicles will soon become popular wildlife survey platforms. Because detection of animals from the air is imperfect, we develop a mark-recapture line-transect method based on footage from two digital cameras, possibly mounted on a single aircraft, which cover the same area with a short time delay between them. Animal movement between the passage of the two cameras introduces uncertainty in individual identity, so individual capture histories are unobservable and are treated as latent variables. We obtain the likelihood by automatically enumerating all possibilities within segments of the transect that contain ambiguous identities, instead of attempting to decide identities in a prior step. We call this method `Latent Capture-history Enumeration', or LCE. We include an availability model for species that are periodically unavailable for detection, such as cetaceans which are undetectable while diving. External data are needed to estimate the availability cycle length, but not the mean availability rate, if the full availability model is employed.

We compare the LCE method with the recently-developed cluster capture-recapture method (CCR), which uses a Palm likelihood approximation, so providing the first comparison of CCR with maximum likelihood. Both methods are approximately unbiased with nearly nominal confidence interval coverage and similar precision. The LCE estimator has slightly lower variance, more so as sample size increases. We illustrate with semi-synthetic data from a harbour porpoise survey.


\end{abstract}

\begin{keywords}
Availability bias; Double-observer survey; Line transect; Mark-recapture; Movement model; Poisson process.
\end{keywords}



\maketitle


\section{Introduction}\label{sec:intro}

%\todo[inline]{RMF - Suggesting some changes in emphasis, taking into account your latest comments about MRDS.
%  It seems to me the usefulness of this work is:\\
%  1. A method for MRDS from a single UAV for ANY aerial survey: animals that move but might not necessarily dive.\\
%  2. Derivation in full generality including both movement and diving model. The diving part of the model doesn't need to be used if not applicable.\\
%  3. Suitable for diving animals if external data is available for $\tau$.\\
%  4. Validation of CCR.\\
%  I've had a go at re-angling the Intro with this structure.  Can we change the title so it doesn't narrow it down to marine mammals, e.g. ``digital aerial surveys of wildlife''?
%  }

  Aerial surveys of wildlife populations allow large areas of land or sea to be surveyed at relatively low expense. We anticipate that aerial surveys with human observers will increasingly be replaced by unmanned aerial vehicle (UAV) surveys using digital video or still cameras. This presents some new statistical challenges. In this paper we address these challenges and develop a method of estimating animal density from cameras deployed from UAVs.

Traditional aerial surveys using human observers involve a reasonably wide field of view, perhaps as much as 1000m either side of the aircraft. Detections of animals decrease with distance from the aircraft, an effect that is modeled using a detection function. By contrast, aerial footage from UAV-mounted cameras has a much narrower field of view --- perhaps 100m to either side --- and detectability can often be assumed to be constant within this zone, in which case a distance-dependent detection function is not needed.
%\todo[inline]{DLB removed this ``The narrow field of view can be compensated for by deploying UAVs on-effort for much longer periods of time than human observers.'' because at present I am not sure it is true.}

Conventional line transect analyses assume that animals are detected with certainty if they are at distance zero from the transect line, which corresponds to the aircraft's path in our case. If this assumption cannot be met, extensions based on mark-recapture methods are employed: see \cite{Burt+al:14} for an overview. The basis of mark-recapture extensions to line transect analyses is to have two observers who search the area independently of each other. The two observers serve as two ``capture occasions'', and animals detected by both observers are described as recaptures or duplicates. The mark-recapture design enables us to estimate the detection probability of each observer, conditional on detection by the other observer, and therefore to adjust for imperfect detection at distance zero. In the case of narrow-strip aerial surveys from UAVs, imperfect detection can result from animals being indistinct or obscured in digital images, so a mark-recapture design may be necessary even if detectability is constant with respect to distance.

Animals of some species may spend a proportion of their time entirely unavailable for detection. For example, whales are unavailable while diving, seals are unavailable at haul-out sites while they are at sea, and birds or amphibians may be available only when vocalising. If some animals are systematically unavailable to both observers, then the unavailable portion of the population is unsampled, so there is no information from which to estimate how large this portion is. %It is therefore important that any systematic causes of unavailability, such as the diving cycle for cetaceans, are explicitly accounted for by survey design and analysis methods.
An ideal sampling design ensures that all animals are subject to the same detection model, so that the sample is representative of the entire population. In the case of animals that are periodically unavailable, for example due to diving, this can be accomplished by incorporating an availability model into the analysis and sampling at more than one time.

There are various ways of sampling at two times. One option is to have two aircraft follow the same transect at a fixed time delay. Ensuring that the narrow search strips of two UAVs overlap adequately can be difficult in some environments and a cheaper alternative is to mount two cameras on a single aircraft: one forward-pointing, the other rear-pointing. These can be engineered so that the rear-pointing camera records the same area as the forward-pointing camera after a time delay of several seconds. This separation generates data with which we can model the availability cycle, as long as there is a chance that the availability status of an animal changes between the passage of the two cameras. For example, a whale might dive or surface during this time interval. In practice, the time delay will need to be sufficiently long relative to the duration of the diving cycle to ensure that the data are adequate to fit the availability model.

Mounting both cameras on the same UAV has the advantage of creating a different viewing aspect for the two cameras: an animal that is obscured from one camera by a bush or shadow might be detectable from the other camera. Likewise, the longer time separation generated by running two UAVs in succession creates the opportunity for either camera to detect an animal that was undetected by the other, due to changes in the animal's position, sunlight, or wind. The two-camera design therefore offers general potential for conducting mark-recapture line transect surveys from the air, regardless of whether or not an availability cycle is involved.

There are two complications. Firstly, because animals may move between the passage of the two cameras, there is uncertainty in whether animals detected in similar locations by the two cameras is the same animal or two different animals. We describe this as {\em uncertainty in capture history}. Each detected animal has a true capture history specifying which of the two cameras detected it, with capture histories $(1, 0)$, $(0, 1)$, and $(1, 1)$ corresponding respectively to detection by only the first camera, only the second camera, or both cameras. When animals are detected from the air, there are usually inadequate visible features for distinguishing between individuals, so recaptures are determined purely on the basis of spatial location and detection time. The longer the time elapsed between the passage of the two cameras, the more difficult it is to distinguish between recaptures of a single individual, and captures of two different individuals. Rather than the capture histories being observed data, as they are in conventional capture-recapture studies, they are now latent variables.

Secondly, although separation in time allows us to deal with availability processes such as diving, there is likely to be dependence between the animal's availability state at the passage of the two cameras, so we are forced to adopt a model that accommodates this dependence. The dependence is reduced as the time delay between the passage of the cameras increases. However, we demonstrate below that the dependence never reduces to zero if animals are mobile, because animal movement in and out of the field of view of the cameras is itself an availability process. Moreover, while longer delays may reduce the dependence between cameras, they exacerbate the problem of capture-history uncertainty.

%Additionally, if both cameras are deployed from a single UAV, the maximum time delay between them is limited by practical considerations.  If cameras are deployed on different UAVs there may be considerable practical difficulties ensuring that the two searched strips overlap sufficiently as wind and other operational factors can result in deviations from intended flight paths.
%\todo[inline]{RMF - removed the comment about two UAVs keeping to the same track as this is now commented on earlier as a ``technological challenge''.}

We develop an analysis framework suitable for two-camera aerial surveys. We explicitly model animal movement into and out of the detection strip between the passage of the two cameras, corresponding to an ``in/out'' availability process that induces dependence between the two cameras. For diving animals, we further consider an ``up/down'' availability process by modeling the diving cycle. As noted by \cite{Stevenson+al:19}, two-observer survey data do not contain sufficient information to identify all parameters of the diving model, if the time delay between cameras is less than the mean dive-cycle duration. In that case, one parameter must be estimated from external data: we take this to be the mean dive-cycle duration itself. We derive our methods in generality including both in/out and up/down availability processes, but the methodology is equally applicable when only the in/out process is required, and in that case there is no need for external data.

To fit the two-camera model we use a full maximum-likelihood approach. We assemble the likelihood by identifying segments of the transect line that have ambiguous animal identities, and enumerating all possible matchings within each segment. As long as animal density is reasonably low, the enumeration is manageable within each segment, and our approach is computationally feasible using a constraint programming algorithm. Conditional on a particular set of matchings, we use a hidden Markov model formulation of the likelihood. This creates a general and extendable modeling framework for two-camera scenarios. We call our new approach the latent capture-history enumeration (LCE) method.

%\todo[inline]{RMF: moved text around so we describe (i) LCE, (ii) past literature, (iii) Hiby \& Lovell, (iv) CCR. Previous order was (i), (iv), (ii), (iii). Also compressed the discussion of the less-relevant models.}

Previous literature has devoted substantial attention to each of the problems of availability and uncertain capture histories, but rarely together. Availability models for double-observer line transect surveys were developed by \cite{Borchers+al:13}, \cite{Langrock+al:13}, and \cite{Borchers+Langrock:15}. Most previous work on uncertain capture histories has focused on methods for resolving uncertainties before fitting conventional models. \cite{Pike+DoniolValcroze:15} used a logistic regression technique to decide on an optimal dissimilarity score between pairs of detections, then established a threshold score within which pairs would be resolved as duplicates. \cite{Hamilton+al:18} devised estimates of the duplicate probability for each pair of detections, and repeatedly resampled from these probabilities within a bootstrap scheme to create a new resolved dataset at each iteration. Other work on latent capture histories has treated the case where observed histories are predictable, but non-invertible, transformations of the latent histories \citep[e.g.][]{Zhang+al:19,Bonner+Holmberg:13,Link+al:10}. This contrasts with our case where no capture histories are observed: only a stream of detections from each camera in continuous time and space.

Our approach is most similar to that of \cite{Hiby+Lovell:98} and \cite{Stevenson+al:19}.  \cite{Hiby+Lovell:98} included both an availability model and uncertain capture histories in their analysis, and they maximized a log-likelihood obtained by summing over possible pairs of detections. They did not allow animal movement in the direction of aircraft travel, and some aspects of their implementation were not explicit. \cite{Stevenson+al:19} derived an alternative approach using the new technique of cluster capture-recapture \citep[CCR; see ][]{Fewster+al:16}. In CCR, the locations of detections are treated as a clustered point-process and the model is fitted using an approximation to the Palm likelihood, which is a likelihood of pairwise distances over all pairs of detections.
%\todo[inline]{BCS: I'm not sure it's quite correct to say an objective function is `fitted'. The model is `fitted' via maximisation of the objective function, though. What about `an objective function calculated from the distribution of...'? \\ RMF: I agree about objective function. I think it's useful to say what the Palm likelihood is, in such a way that it's clear why it's called a `likelihood', so I've modified the text as above. Note that we do use an approximation to the Palm likelihood, not the Palm likelihood itself, because we can't incorporate the dependence between the pairwise comparisons: this links to a later comment of Ben's.}
The CCR method is asymptotically consistent and remains computationally efficient at high animal densities, unlike the LCE method we present here. However, it is not based on a true likelihood, and its performance has never been compared against that of maximum likelihood due to the difficulty of computing likelihoods in the scenarios for which CCR is intended. Another key output of the present work is therefore the first comparison between CCR and maximum likelihood.

%\todo[inline]{DLB: Best be up front about differences, I think. Could move some/all of this to Discussion, but don't feel it fits that well there. \newline RMF: I've toned down the H\&L bit: is it true to say that the method for likelihood construction is not specified?  This would be the kindest word if it's correct, since it doesn't imply that they simply failed to explain themselves properly.  Other options: `not explicit', `not clear'.}

% Previous H\& L text:
%and who estimated density by maximising a likelihood that involved summing over all possible pairings of detections. They incorporate a distance-dependent detection function, they do not deal with varying lag due to animal movement, they use a different movement model, and some aspects of their method are not clear from their paper, including the method used to sum over pairings. By formulating the likelihood using a hidden Markov model, and using segmentation and constraint programming (see below) we provide a transparent, general and extendable framework for this kind of model.



%%@@
%Our approach is the first fully likelihood-based method that does not require capture histories to be assigned to individuals, and incorporates both in/out and up/down availability processes.


%\todo[inline]{RMF - I have conspicuously omitted Hiby \& Lovell from the preceding discussion, as I don't know how to describe what they did in context.  (Pseudo-likelihood? Failed likelihood?) I've obliquely said that full MLE has `has not previously been achieved', i.e.\ whatever H\&L did, it wasn't a full MLE.  Is it OK just to quietly not mention them in this context?  It's likely that they would be asked to be referees if we say explicitly that they tried to do what we've just done.  We do cite them later but I'm inclined not to make it too explicit how close the link is. OK?}

%\todo[inline]{DLB: Borchers and Langrock do have two observers, but although they model availability to account for $g(0)<1$, they identify recaptures. The only reasons to mention Borchers+al:13, Langrock+al:13 and Borchers+Langrock:15 here are (a) they model availability - which is relevant here, and (b) it will increase my citation rate!

%Good if you could put in the refs you mention above, but I had also thought that papers like Vale, R.T.R., Fewster, R.M., Carroll, E.L., and Patenaude, N.J. Maximum likelihood inference for model Mt,$\alpha$ for capture-recapture data with misidentification. Biometrics, 70, 962â€“971, 2014, and related stuff on latent capture history models done by Brett McClintock and by Bill Link would be relevant.

%RMF - the latter are only tangentially relevant.  I've put them in, but do you still want them?  They will take up space here and more so in the reference list.  Not sure how we're doing for space at the moment.}


%\todo[inline]{DLB: I have commented out the rest of the text in the Intro, as it is superceded by what is written above.}
%%%



%There are two ways in which this problem has been dealt with. The first is to model the latent process, i.e., the availability process. For example, \cite{Borchers+al:13} modeled latent availability using a hidden Markov model, while \cite{Langrock+al:13} and \cite{Borchers+Langrock:15}  modeled it using Markov modulated Poisson processes. The second way is to separate the times that the two observers search the same region, either by having one observer search far ahead of the aircraft and the other close to it, or by using two aircraft in tandem, or having a single aircraft circle back over its path a second time \citep[see][]{Hiby+Lovell:98}.


%Separating UAV ``observers'' (cameras) by using UAVs in tandem or circling back on themselves is much less feasible than doing the same with human observers on aircraft. This is because field conditions are typically such that it is not possible for the aircraft doing the second pass to follow exactly the path of the aircraft doing the first pass. When observer field of view is around 2,000m wide (as is not unusual with human observers), having a second pass that deviates by 200m from the path of the first pass still leaves considerable overlap between the regions surveyed by each observer. It would leave no overlap at all for UAVs with a field of view 200m wide.

%The method we develop (which we will refer to as the ``Latent Capture history Enumeration'' method, or LCE method for short) is similar to that of \cite{Stevenson+al:19} in that it has the same data requirements and does not require capture histories. It differs in that we do inference by maximum likelihood rather than using an approximation to the likelihood. Unlike the method of \cite{Stevenson+al:19}, the LCE method becomes computationally infeasible when there are very many plausible pairings of detections by different observers. %(The number of possible pairings of $n$ detections is given by the Bell number \citep{Becker+Riordan:48}, which grows extremely quickly as $n$ increases; for example, it is 877 for $n=7$ and 115,975 for $n=10$.) We investigate its utility for aerial UAV surveys and compare it to the method of \cite{Stevenson+al:19}.


\section{Models for movement and availability\label{sec:genmod}}

%\todo[inline]{RMF - subsection structure edited and various small edits throughout this section}

Two observers move along a transect line, one behind the other, searching a strip of half-width $w$. They move at constant speed $v$ and are separated by a time-lag $l$ and distance $vl$. We use the general term `observers' and develop the model for lags $l$ of any size, but we anticipate that the two observers are most likely to be two cameras on the same UAV.

We use two coordinates for location: the forward coordinate along the transect line, and the transverse coordinate perpendicular to the line. We say that an observer `passes over' an animal at the instant that their forward coordinates coincide, regardless of the animal's transverse coordinate at that instant. We assume that observer speed exceeds animal speed, so the time at which each observer passes over each animal is well-defined.

Animals may move between the passage of the two observers. We model this as a Brownian motion, such that the animal's displacement over time $t$ follows a bivariate normal distribution with mean $(0,0)$ and variance $\bm{\Sigma}(t)=\sigma^2t\bm{I}$, where $\bm{I}$ is the $2\times 2$ identity matrix.


\subsection{Forward movement}
%***\todo[inline]{Fix the appendix labels when manuscript ready to go.}

For a given animal, the time elapsed between the passage of the first and second observers overhead is a random variable $T$. We show in Appendix~A that $T$ has probability density function (PDF)
\be
f_{T}(t)&=&\frac{vl\exp\left\{-\frac{v^2(l-t)^2}{2\sigma^2t}\right\}}{\sqrt{2\pi\sigma^2t^3}}.
\label{eq:fTt}
\ee

%For $T=t$, the animal's forward displacement between the passage of the two observers is $v(t-l)$, and the PDF of its forward displacement is $\phi\big(v(t-l)\,; \sigma^2 t\big)$, where $\phi(\cdot\,; \sigma^2t)$ is the normal density with mean 0 and variance $\sigma^2t$.

%\todo[inline]{RMF - removed comment about forward distance of the animal during time $t$: not used.}


%It follows that the distance $y=vt$ that the animal has moved in the forward direction when the second observer passes it is
%\be
%f_{Y|k}(y|k)&=&\frac{vl\exp\left\{-\frac{(vl-y)^2}{2\sigma^2y/v}\right\}}{\sqrt{2\pi\sigma^2y^3/v}}.
%\ee

\subsection{Transverse movement and in/out availability}

%\todo[inline]{RMF - changed from $Y(0)$, $Y(t)$ to $Y_0$, $Y_t$ for conciseness / convention. Also corrected $Y_t-Y_0 \sim N(0, \sigma^2t)$.}

The survey design involves two observers detecting animals within a strip of width $w$ either side of the line. As animals may move into or out of the detection zone between the passage of the two observers, we consider the survey area to constitute a wider strip of width $b>w$ either side of the line, where the buffer $b$ is chosen such that there is negligibly small probability that animals beyond $b$ at the passage of the first observer will be within the searched strip $w$ at the passage of the second. The buffered strip of width $2b$ therefore covers all animals that may be exposed to detection.

Let $Y_0$ be the signed distance of an animal to the right of the transect line when the first observer passes overhead, and $Y_t$ be this distance time $t$ later. We assume that $Y_0\sim U(-b,b)$, independently for all animals. Our movement model implies that $Y_t-Y_0\sim N(0,\sigma^2t)$.

For any animal within the buffered strip $2b$ at the passage of the first observer, let the binary random variable $Z_t$ be 1 if the animal is within the detection zone of width $2w$ at time $t$, and 0 otherwise. Thus $Z_t$ describes the animal's in/out availability for detection at time $t$. The probability $\mathbb{P}(Z_t=0 \mid Z_0=1)$ that an animal moves from inside to outside the detection zone during time $t$, and the probability $\mathbb{P}(Z_t=1\mid Z_0=0)$ that it moves from outside to inside the detection zone, are
\be
p_{IO}(t)=\mathbb{P}(Z_t=0 \mid Z_0=1)&=&\frac{1}{w}\int_{0}^w \left\{ \Phi(y-w;\sigma^2t)+\Phi(-y-w;\sigma^2t)\right\} dy
\label{eq:p_{IO}}\\
p_{OI}(t)=\mathbb{P}(Z_t=1 \mid Z_0=0)&=&\frac{1}{b-w}\int_w^{b} \left\{ \Phi(y+w;\sigma^2t)-\Phi(y-w;\sigma^2t) \right\} dy
\label{eq:p_{OI}}
\ee
%\todo[inline]{Lifted from old notes without checking -- needs checking.}
\noindent
where $\Phi(\cdot;\sigma^2t)$ is the cumulative distribution function of a normal random variable with mean zero and variance $\sigma^2t$.

We model in/out availability as a two-state Markov process with transition probabilities over an interval of time $t$ given by Eqns~\eqref{eq:p_{IO}} and \eqref{eq:p_{OI}}:
\be
\bm{M}(t)&=&
\left(
\begin{array}{cc}
1-p_{IO}(t) & p_{IO}(t) \\
p_{OI}(t) & 1-p_{OI}(t)
\end{array}
\right)\,.
\label{eq:M}
\ee
The stationary distribution of the in/out Markov chain, which gives the long-term proportion of time spent in each state, is $(w/b, \;1-w/b)$.


%%%RMF - delete this?
%%%There are two reasons that animals that are within the survey strip at some point between the passing of the first and second observers may not be available for detection. The first is that they are invisible to the observers because they are diving. The second is that they are invisible because they are not within the strip at the time they are passed. We construct models for each of these processes below.
%%%

\subsection{Diving behavior and up/down availability}

We model animal diving behavior using a two-state continuous-time Markov chain such that the time spent in state 1 (the near-surface state) is an exponential random variable with expected value $\kappa$, and the time spent in state 2 (the diving state) is an exponential random variable with expected value $\tau-\kappa$, where $\tau$ is the expected dive cycle duration. The Markov transition rate matrix $\bm{Q}$ is
\be
\bm{Q}&=&
\left(
\begin{array}{cc}
-\frac{1}{\kappa} & \frac{1}{\kappa} \\
\frac{1}{\tau-\kappa} & -\frac{1}{\tau-\kappa}
\end{array}
\right) \,.
\label{eq:Q}
\ee
\noindent
The up/down state transition probability matrix at time separation $t$ is $\bm{U}(t)=\exp(\bm{Q}t)$. The stationary distribution of the Markov chain is $(\gamma, \:1-\gamma)$, where $\gamma=\kappa/\tau$.

%\todo[inline]{RMF - put the stationary distribution $\bm{\pi}$ inline, and we don't need a notation for it.}

\subsection{Combined availability model}


The possibilities of being in or out of the detection zone, and up or down with respect to diving, generate four states that animals can occupy: (up and in), (up and out), (down and in), and (down and out). We number the states 1 to 4 in that order. Assuming that the up/down state is independent of the in/out state, the matrix of transition probabilities between these states at time separation $t$ is the Kronecker product $\bm{\Gamma}(t)=\bm{U}(t)\otimes\bm{M}(t)$. Using a matrix formulation for $\bm{\Gamma}(t)$ provides an extendable and computationally efficient way of dealing with the hidden states 2, 3, and 4. The stationary distribution for the four-state Markov process is
\be
\bm{\delta}&=&\Bigg(
\gamma\frac{w}{b},\;
\gamma\left(1-\frac{w}{b}\right),\;
\left(1-\gamma\right)\frac{w}{b},\;
\left(1-\gamma\right)\left(1-\frac{w}{b}\right)
\Bigg).
\label{eq:delta}
\ee



\section{Detection model}

We assume that the probability that an animal is in each state at the time the first observer passes over it is given by the stationary distribution $\bm{\delta}$, and hence that its state distribution after a waiting time $t$, when the second observer passes it, is $\bm{\delta}\bm{\Gamma}(t)$.

Define the binary variable $X_{ij}$ to be 1 if animal $i$ is detected by observer $j$ and zero otherwise. We model $X_{ij}$ as a state-dependent Bernoulli random variable with parameter $p_j(c)=\mbox{Pr}(X_{ij}=1\mid C_{ij}=c)$ where $C_{ij}$ is the state of animal $i$ when observer $j$ passes over it, and $c\in \{1,2,3,4\}$.
It follows that $X_{ij}$ ($j \in \{1, 2\}$) are observations from a Markov modulated Bernoulli process. %\todo[inline]{BCS: Maybe ($j \in \{1, 2\}$) instead?\\ RMF: done -- change made above.}

%\todo[inline]{RMF - no need to define $t_{i1}$ and $t_{i2}$ here. Acronym MMBP never used again so removed.}

% at times $t_{i1}$ and $t_{i2}$. It is convenient to define the time at which the first observer passes animal $i$ ($t_{i1}$) to be zero, so that the time at which the second observer passes is $t_i=t_{i2}-t_{i1}$ ($t$ in the development of the previous section).

It is convenient to arrange the state-dependent probability mass functions of $X_{ij}$ in a diagonal matrix \citep[see][Eqn 2.13]{Zucchini+al:16}. For observer $j$, this matrix is
\be
\bm{P_j}(x_{ij})\;=\;
\begin{blockarray}{cccc}
\text{up,in} & \text{up,out} & \text{down,in} & \text{down,out} \\
\begin{block}{(cccc)}
\text{Bern}(x_{ij};p_j(1)) & 0 & 0 & 0 \\
0 & 1-x_{ij} & 0 & 0 \\
0 & 0 & \text{Bern}(x_{ij};p_j(3)) & 0 \\
0 & 0 & 0 & 1-x_{ij} \\
\end{block}
\end{blockarray}
\ee
\noindent
where $\text{Bern}\big(x_{ij};p_j(c)\big)\equiv p_j(c)^{x_{ij}}\{1-p_j(c)\}^{1-x_{ij}}$. The above matrix allows for animals to be detected in the `down' state, but not in the `out' state. We now assume that $p_j(3)=0$, so that only animals in the `up' state can be detected, but in general this need not be the case.

Let $t_i$ be the time elapsed between the passage of the first and second observers over animal $i$.
Conditional on $t_{i}$, the probability of observing capture history $(x_{i1},x_{i2})$ for animal $i$ can be expressed as the following matrix product, which efficiently sums over hidden states:
\be
\mathbb{P}(x_{i1},x_{i2}\mid t_{i})&=&
\bm{\delta}\bm{P_1}(x_{i1})\bm{\Gamma}(t_{i})\bm{P_2}(x_{i2})\bm{1}\,,
\label{eq:p_omga}
\ee
\noindent
where $\bm{1}$ is a column vector of ones. We label the three observable capture histories as $\dotomega_1=(0, 1)$, $\dotomega_2=(1,0)$, and $\dotomega_3=(1,1)$, and define $q_k(t) = \mathbb{P}(\,\dotomega_k \mid t)$ as given in \eqref{eq:p_omga}. The overall probability of capture history $\dotomega_k$ is then
\begin{equation}
\tilde{q}_k=\mathbb{P}(\,\dotomega_k\,)=E_{t}\left\{ \mathbb{P}(\,\dotomega_k \mid t) \right\}=\displaystyle\int q_{k}(t)f_{T}(t)\,dt\,.
\label{eq:ptilde}
\end{equation}
\noindent

%\todo[inline]{BCS: It's probably that I take a little while to digest equations, but I find the use of $q_k(t)$ a bit confusing and it's not clear why we don't just use $\mathbb{P}(\omega_k \mid t)$. For example, I would have found $\mathbb{P}(\omega_k) = \int_0^\infty \mathbb{P}(\omega_k \mid t) f_T(t) dt$ a bit easier to digest. Is it because using $\tilde{q}_k$ instead declutters Eq (10)?\\
%  RMF: yes, I don't think we can change this, because the $q_k$ notation leads into $\tilde{q}_k$ and $\tilde{q}_\cdot$ and we couldn't replace all these by longhand in later equations. Instead, I've changed the middle terms in the equation above to make the link with $\mathbb{P}(\omega_k \mid t)$ more concrete. Also changed to $\dotomega_k$ in response to Ben's later comment.}


%\todo[inline]{RMF - removed the joint probability statement above, as it isn't needed beyond the expectation; and the $p_{01}(t_i)$ etc notation, which isn't needed and can be confused with transition probabilities. Likewise replaced their only other occurrence in Section 7. Also simplified notation around $\omega$ and $\tilde{p}_k$.}
%The joint probability of the second observer passing animal $i$ at $t_{i}$ and observing $(x_{i1},x_{i2})$ is $p(x_{i1},x_{i2}\mid t_{i})f_{T}(t_{i})$. For brevity, we now write $p(x_{i1}=0,x_{i2}=1\mid t_{i})$ as $p_{01}(t_{i})$, we write $p(x_{i1}=1,x_{i2}=0\mid t_{i})$ as $p_{10}(t_{i})$, and we write $p(x_{i1}=1,x_{i2}=1\mid t_{i})$ as $p_{11}(t_{i})$.


\section{Survey model}

%\todo[inline]{RMF - removed mention of $2bD(s)$, as the meaning of intensity is number per unit area. Simplified likelihood notation and derivation.}

We assume that the number and locations of animals in the forward direction, within distance $b$ of the transect line at the time that the first observer passes overhead, are governed by a Poisson process with intensity $D(s)$ at along-transect location $s$. We derive the likelihood by supposing that the capture history $\omega_i$ of each animal $i$ is known. We will later revoke this requirement by marginalizing over all possible assignments of detections to capture histories.

%As mentioned above, we also assume that animals are uniformly distributed on the interval $(-b,b)$ perpendicular to the transect line, so that the number and location of animals within distance $b$ of the transect follows a Poisson process with intensity $D(s,y)=2bD(s)/2b=D(s)$ at along-transect distance $s$ and perpendicular distance $y\in (-b,b)$ %As a result, points within a distance $b$ of the transect are located in the along-transect dimension according to a Poisson process with intensity $2bD(s)$, where $s$ is the distance along the transect.

Let $\bm{s}=(s_1, \ldots, s_n)$ be the observed forward locations of the $n$ detected animals at the time of first detection. We can write $\bm{s}=\left(\bm{s}^{(1)}, \bm{s}^{(2)}, \bm{s}^{(3)}\right)$ , where $\bm{s}^{(k)}$ corresponds to locations of animals with capture history $\dotomega_k$ for $k=1, 2, 3$. Each set of locations $\bm{s}^{(k)}$ arises from thinning the overall Poisson process by probability $ \tilde{q}_{k}$. Because multinomial splitting of a Poisson process produces independent Poisson subprocesses, the likelihood of $\bm{s}$ is the product of the three likelihoods from the thinned subprocesses. For animals with capture history $\dotomega_3=(1,1)$, there are additional observations on the time delay $t$ between detection by the first and second observers, providing information about the movement parameter $\sigma$. The PDF of waiting time $T$, conditional on the capture history being $\dotomega_3$, is
\be
f_{T \mid \,\omega} (t \mid \dotomega_3) = \frac{f_T(t) \,\mathbb{P}(\dotomega_3 \mid t)}{\mathbb{P}(\dotomega_3)} =  \frac{f_T(t) \,q_3(t)}{\tilde{q}_{3}}\,,
\label{eq:fTgivenOmega}
\ee
where the right-hand side of \eqref{eq:fTgivenOmega} is obtained from Equations~\eqref{eq:fTt}, \eqref{eq:p_omga}, and \eqref{eq:ptilde}. This PDF is included as an auxiliary component to the Poisson process likelihood for $\bm{s}^{(3)}$.

Let $L$ be the total transect length of the survey, and let $n_k$ be the number of observations of capture history $k=1, 2, 3$, with $n_1+n_2+n_3 = n$. Let $\tilde{q}_\cdot=\tilde{q}_1 + \tilde{q}_2 + \tilde{q}_3$ be the overall probability of detection. We write $\bm{s}$, $\bm{\omega}$, and $\bm{t}$ for the locations, capture histories, and (where available) time delays for animals $i=1, \ldots, n$. The parameter vector is $\bm{\theta}$. The likelihood is:
\be
\mathcal{L}(\bm{\theta}\,;\,\bm{s},\bm{\omega}, \bm{t}) = \frac{\exp\left\{ - \int_0^L D(u) \tilde{q}_{\cdot}\,du \,\right\}}{n_1! \,n_2!\, n_3!}
\left\{\prod_{i=1}^n D(s_i) \right\} \tilde{q}_1^{\,n_1}\, \tilde{q}_2^{\,n_2}\,
\prod_{i \,: \, \omega_i=\dotomega_3} \big\{f_T(t_i) \,q_3(t_i) \big\} \,.
\label{eq:LDs}
\ee

%\todo[inline]{BCS: I find the notation for $\omega$ a little confusing. At first we have $\omega_1 = (0, 1), \omega_2 = (0, 1), \omega_3 = (1, 1)$, for example, but later on in Section 5 we say that $\omega_i$ are known for animals $i = 1, \cdots, n$, suggesting that $\omega_1$ is the true capture history for the $i$th individual, not necessarily $(0, 1)$. I'm generally rusty on set notation, but I'm not sure $i \,: \, \omega=\omega_3$ is quite rigorous enough, because $i$ doesn't appear after the colon. If $\omega_i$ is the capture history for the $i$th animal (as defined in Section 5) then I guess we could use $i \, : \, \omega_i = (1, 1)$?\\
%RMF: this distinction between $\omega_i$ and $\omega_3$ has been a perennial problem. I've changed the three fixed capture histories to $\dotomega_k$ throughout using a Latex newcommand \textbackslash dotomega, which can be redefined if David doesn't like it. So now $\omega_i$ ONLY means capture history for animal $i$.}


\subsection{Homogeneous density}

In the homogeneous case, where density is constant throughout the survey, we have $D(s)=D$. The likelihood is:
\be
\mathcal{L}(\bm{\theta}\,;\,\bm{s},\bm{\omega}, \bm{t}) = \frac{\exp\left( - L D \,\tilde{q}_{\cdot}\,\right)}{n_1! \,n_2!\, n_3!} \, D^n\, \tilde{q}_1^{\,n_1}\, \tilde{q}_2^{\,n_2}\,
\prod_{i \,: \, \omega_i=\dotomega_3} \big\{f_T(t_i) \,q_3(t_i) \big\} \,.
\label{eq:LD}
\ee

\subsection{Model parameters}
\label{sec:model_parameters}

The model has four kinds of parameters:

\textbf{Density parameters}: In the case of the homogenous Poisson process there is one parameter, $\theta$, such that $D=e^{\theta}$. When density varies with covariates, $\theta$ is replaced by a linear predictor involving a parameter vector.

\textbf{Dive cycle parameters}: The two-state dive cycle model described above is parametrized in terms of the mean dive cycle length, $\tau$, and the mean proportion of time in the near-surface state, $\gamma$, which are linked to parameters $\alpha_\tau$ and $\alpha_\gamma$ via log and logit links: $\tau=e^{\alpha_\tau}$ and $\gamma=e^{\alpha_\gamma}/(1+e^{\alpha_\gamma})$.

\textbf{Movement parameters}: The animal movement model has one parameter, $\sigma$, which we model using a log link: $\sigma=e^\phi$.

\textbf{Detection parameters}: Assuming that animals are only detectable when in state $c=1$ (up, in), we have two Bernoulli parameters to model: $p_1(1)$ and  $p_2(1)$. These can be modeled using logit link functions. If the observers are identical digital detectors, it may be reasonable to assume these two probabilities are identical, i.e. $p_1(1)=p_2(1)=p=e^\beta/(1+e^\beta)$.

As is the case for density, covariates can be incorporated into the other three models by replacing the corresponding scalar parameter on the link scale with a suitable linear predictor involving the covariates.

%\todo[inline]{RMF - don't need notation $\bm{\theta}^*$.}

For the rest of this paper, we focus on the constant density model with identical detectors and no covariates, which has five parameters: $(\theta,\alpha_\gamma,\alpha_\tau, \phi, \beta)$. \cite{Stevenson+al:19} showed that these are not all identifiable from the two-observer survey design. For the detection model, they assumed that $p=e^\beta/(1+e^\beta)=1$. This is reasonable for digital aerial surveys conducted in calm sea states, if we define the near-surface state to be ``at or breaking the surface'': a state that is easily observed. The field of view of a digital camera is such that objects towards the periphery of the image are as easily detected as objects in the centre of the image, so a detection function that drops off with distance from the line is not needed.

\cite{Stevenson+al:19} also showed that even when $p$ is known, only two of $(\theta,\alpha_\gamma,\alpha_\tau)$ are identifiable, so one of these parameters must be estimated using external data. We follow \cite{Stevenson+al:19} and \cite{Hiby+Lovell:98} and assume that the mean dive cycle duration $\tau=e^{\alpha_\tau}$ is estimated separately, so we treat it as known in the present survey. In what follows, we therefore assume that detection of animals in the up/in state is certain ($p=1$); we use external estimates to set $\tau$; and we estimate the remaining three parameters. These constitute the density, $D$; the mean proportion of time in the near-surface state, $\gamma$; and the movement parameter, $\sigma$. The parameter vector is therefore $\bm{\theta}=(\theta,\alpha_\gamma, \phi)$.

%We do this using the locations along the transect line of detections by the first observer and the locations along the transect line of detections by the second observer (and known observer speed) without assigning capture histories to any individual.

%\todo[inline]{RMF - corrected estimating $\kappa$ to estimating $\gamma$ above. Also removed last sentence which is relevant to the next section.}

\section{Marginalising over the latent capture histories}

The likelihoods \eqref{eq:LDs} and \eqref{eq:LD} are formulated under the supposition that the capture history vector $\bm{\omega}$ is known for animals $i=1, \ldots, n$. However, the core problem when observers are separated in time is that the capture histories cannot be known with certainty: they are latent variables. Here we address this problem by enumerating all plausible combinations of latent capture histories. We marginalize the likelihood by summing over the individual likelihoods for every plausible capture history combination. We refer to each combination of capture histories as a ``pairing'', since once the pairs of detections with capture history $\dotomega_3=(1,1)$ have been decided, the capture histories $(0, 1)$ or $(1, 0)$ of all other detections are determined, because we know which of the two observers made each detection.

Calling the $m$th set of pairings $\bm{\omega}^{(m)}$, and the associated vectors of first-detection locations and time delays  $\bm{s}^{(m)}$ and $\bm{t}^{(m)}$ respectively, we obtain the likelihood for the parameters $\bm{\theta}$ as
%we can consider $\mathcal{L}(\bm{\theta};\bm{s}\mid\bm{\omega}^{(m)}, \bm{t}^{(m)})$ to be the conditional likelihood, given $\bm{\omega}^{(m)}$.
\be
\mathcal{L}(\bm{\theta})&=&\sum_{m=1}^M\mathcal{L}\left(\bm{\theta}; \bm{s}^{(m)},\bm{\omega}^{(m)}, \bm{t}^{(m)}\right)\,,
\ee
\noindent
where $M$ is the number of plausible pairings.


While this likelihood is easy to write down, it is challenging to evaluate because we need to enumerate all $M$ plausible combinations $\bm{\omega}^{(m)}$. For any but very small sample sizes, the number $M$ of possible pairings is very large. We tackle this problem by first partitioning the location vector $\bm{s}$ into subsets between which paired detections are impossible, to reduce the number of plausible pairings, and then using a constraint programming technique for efficient enumeration of all possible pairings within subsets.


\subsection{Subdivision of $\bm{s}$}

We partition $\bm{s}$ by ``cutting'' the transect line immediately after detections by observer $j$ for which the distance to the next detection by the other observer is greater than a maximum possible distance that an animal could have moved between the two observers passing over it ($d_{max}$). This distance $d_{max}$ must be decided using knowledge of the movement speed and behavior of the target species. A suitable value for $d_{max}$ can be chosen by doing inference at a range of plausible values to find where estimates become insensitive to $d_{max}$. The cost of setting $d_{max}$ too large is in computational speed; the cost of setting $d_{max}$ too small is positive bias in estimation of $D$, since setting $d_{max}$ too small will result in some animals with true capture history $(1,1)$ being assigned capture history $(0, 1)$ or $(1,0)$.

%\todo[inline]{RMF - changed $C$ and $c$ to $R$ and $r$ below, as $C$ and $c$ are HMM states.}
Having divided the transect line into $R$ segments, we enumerate the possible pairings $\bm{\omega}^{(m_r)}$ for segments $r=1,\ldots,R$. Let $M_r$ be the number of possible pairings in segment $r$. We calculate the likelihood as
\be
\mathcal{L}(\bm{\theta})&=&\prod_{r=1}^R\sum_{m_r=1}^{M_r}\mathcal{L}\left(\bm{\theta};\bm{s}^{(m_r)},\bm{\omega}^{(m_r)},\bm{t}^{(m_r)}\right)\,.
\ee

When $d_{max}$ is substantially smaller than most of the distances between detections by different observers, segmentation can lead to a massive reduction in computation time, making it quite feasible to compute what would otherwise be an intractable likelihood.

\subsection{Constraint programming for enumerating all $\bm{\omega}^{(m)}$}
\label{sec:constrprog}

For efficient enumeration of the possible pairings within one segment, we define a simple constraint satisfaction problem (CSP)~\cite[Chapter 6]{russell-norvig-aima3}. A CSP is a triple \(\mathcal{P}=\langle \mathcal{X}, \mathcal{D}, \mathcal{C} \rangle\).  The CSP \(\mathcal{P}\) has a set of decision variables \(\mathcal{X}\), each of which has a set of possible values that it may take, called its \textit{domain}, where \(\mathcal{D}(x)\) is the domain of \(x \in \mathcal{X}\). In addition there is a set of constraints \(\mathcal{C}\) that restrict the combinations of values that may be taken by the variables. A constraint \(c\in \mathcal{C}\) is a relation defined on a set of variables: \(\mathrm{scope}(c)\subseteq \mathcal{X}\). A \textit{solution} is an assignment of values to variables such that each variable is assigned a value from its domain, and all constraints are satisfied.

We define a CSP for a segment as follows. Two detections by different observers may be paired if and only if the distance between them is less than or equal to \(d_{max}\). For each set \(\{i,j\}\) of two observations that may be paired, we define one decision variable \(x_{i,j}\) with domain \(\{0,1\}\). Variable \(x_{i,j}\) is equal to 1 in a solution if and only if the two observations are paired.

Suppose we have two distinct sets, \(s_1=\{i,j\}\) and \(s_2=\{k,l\}\), where  \(i\) may be paired with \(j\), and \(k\) may be paired with \(l\), but the two sets are not disjoint: in other words \(s_1 \cap s_2 \ne \emptyset\). The two sets cannot both be paired simultaneously because they share an observation. In all such cases we add the constraint \((x_{i,j}=0 \vee x_{k,l}=0)\) to prevent such pairing.

We use a backtracking search procedure with forward checking~\cite[Chapter 6]{russell-norvig-aima3} to enumerate all solutions to the CSP. The set of solutions to the CSP corresponds one-to-one to the set of valid pairings within the segment. When a solution is found, the part of the likelihood pertaining to that pairing is calculated, avoiding the need to store the set of pairings and allowing efficient calculation of $\sum_{m_r=1}^{M_r}\mathcal{L}\left(\bm{\theta};\bm{s}^{(m_r)},\bm{\omega}^{(m_r)},\bm{t}^{(m_r)}\right)$.

\subsection{Interval estimation}
\label{sec:ci}

We estimate the variances of parameters using the inverse of the Hessian obtained in the fitting process. Confidence intervals for the parameters $D$, $\sigma$ and $\gamma$ are gained from the inverse log transformation of confidence intervals for $\theta$ and $\phi$, and the inverse logit transformation of $\alpha_\gamma$, assuming normality of the maximum likelihood estimators of these parameters.


\section{Application \label{sec:applic}}

We use the term `Latent Capture-history Enumeration' method, or LCE, to describe our framework. We  developed this method in anticipation of digital aerial survey data becoming widely used, but, pending the availability of analysis methods such as the LCE method developed here, such data are not yet available. We therefore estimate density from the semi-synthetic data used by \cite{Stevenson+al:19}. These data are taken from an aerial survey of harbor porpoise ({\em Phocoena phocoena}) in the North Sea using human observers, compiled from periods when the aircraft circled back over its transect after a lag of $l=248$ seconds.
%\todo[inline]{BCS: I really should have thought of this before, but the circle-backs were not actually all at 248 s. Instead, the average lag across all circle-backs was 248 s. I just took the average because my CCR code can't deal with different lags for different transects. However, this method can incorporate the different lags more easily can't it? Do we also want to analyse these data with the exact lags, rather than the average lag?\\
%RMF: I vote for not doing any more analyses. We could insert `average', as in, `after an average lag of $l=248$ seconds', but I don't feel we need to make a big deal of this since it's synthetic data anyway. I haven't made any change.}
The two observers correspond to the two passes of the aircraft. Only data in a narrow strip of half-width $w=0.125$ km are included, to mimic the narrow field of view and perfect near-surface detection characteristic of digital observers. As noted by \cite{Stevenson+al:19}, a lag of $l=248$ seconds is longer than any plausible value for $\tau$, and as a consequence the surfacing states of an animal at the times the two observers pass are independent and the estimator is robust to unknown $\tau$. For shorter lags $\tau$ needs to be specified (see Section~\ref{sec:sim}).

%\todo[inline]{RMF - Ben didn't need to specify $\tau$ for this analysis because the two observers were considered independent for such a long lag. How did you deal with this? There hasn't been a previous mention of $\tau$ not being needed if you can assume independence. In some ways this should come after the comments done in Fig 1, but I can see why you want to put the application first; so some sort of comment is needed.\\
%DLB: I set $\tau$ in the estimation code, to be 110 seconds, as in Ben's simulations, but also checked that estimates were insensitive to $\tau$ by estimating with some other values. Added the two sentence at end of paragaph above.}

\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}


{\ttfamily\noindent\bfseries\color{errorcolor}{\#\# Error in library(twoplane): there is no package called 'twoplane'}}\end{kframe}
\end{knitrout}













